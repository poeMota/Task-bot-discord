# Таск бот для проектов по SS14
Данный бот создан для организации работы отделов по принципу "тасков", бот сильно интегрирован со Space Station 14 и её сервисам, но может быть использован вне контекста данной игры.

## Концепция тасков и проектов
Бот использует такие термины как "проекты" и "таски" (иногда также используется "бригады").
- **Проект** - сущность, которая имеет ассоциированный с ней канал-форум, роли и таски. Проекты собирают статистику по всем пользователям, которые имеют роль, ассоциированную с проектом.
 
  **Параметр проекта**:
  - **максимальное количество тасков на человек** - во скольких тасках максимально может участвовать любой пользователь.
  - **роль ждуна** (не обязательно) - роль, которую будет пинговать при каждом создании тасков проекта.
  - **форум** - канал-форум для тасков проекта, все публикации в этом канале станут интерпретироваться как таски.
  - **основной канал** - основной канал проекта, на данный момент этот параметр ни на что не влияет.
  - **канал статистики** - в данном канал будет размещён автообновляемый пост статистики проекта.
  - **роли проекта** - discord роли, ассоциированные с данным проектом, все кто имеют любую из этих ролей смогут вступать в таски и будут отображаться в статистике.
  - **теги** - теги из форума тасков проекта, которые влияют на таски. Теги могут влиять на базовое количество очков, получаемое при завершении таска, на максимальное количество членов таска и на то, какие дополнительные роли будет пинговать при создании данного таска.


- **Таски** - публикации в канале-форуме любого проекта, таск может иметь сложность (базовые очки за его выполнение) и максимальное количество человек, которое может в него вступить.
  Пользователи, которые имеют роль, ассоциированную с проектом могут вступать в любые таски проекта, пока не достигнут лимита по таскам на одного человека, который настраивается в конфиге проекта.
 
  **Параметры тасков** (все данные параметры определяются автоматически при создании публикации или её обновлении):
  - **название** - берётся из названия публикации
  - **дата создания**
  - **базовые очки за выполнение таска** (определяется тегами)
  - **последний сейв** - параметр, который используется для маппинг тасков, его можно задавать командой /последний-сейв
  - **бригадир** - куратор данного таска, кто ответственен за координацию работы его участников, задаётся командой /взять-заказ
  - **члены бригады** - пополняются при вступлении в таск
  Чтобы вступить в таск нужно нажать на базовое эмодзи форум-канала тасков. Для завершения таска нужно использовать команду /закрыть, по завершении члены таска получат очки за работу, количество очков определяет тот, кот закрывает таск.

  **Команды тасков**
 
  Бот имеет в своём арсенале "контекстные команды", это команды, которые работают только в ветках тасков и работают применительно к таску, где их использовани.
  Вот список этих команд: /взять-заказ, /изменить-таск, /таск-инфо, /закрыть, /последний-сейв


### Очки
Бот использует систему очков для поощрения за работу в тасках, за таски его участники получают `базовое_количество_очков_таска * модификатор_качества_работы`, модификатор определяет тот, кто закрывает таск, список модификаторов описаны в конфиге бота, для куратора заказа формула выглядит так: `базовое_количество_очков_таска * brigadire_score_modifier`, модификатор для куратора также находится в конфиге бота.

Очки могут быть потрачены в магазине бота.


### Магазин
Заработанные очки можно тратить в магазине, который открывается командой **/магазин**, подробнее о его настройке и возможностях подробнее будет описано в разделе **конфигурация бота**.


### Сейвы
Бот может быть интегрирован с nginx сайтом для скачивания файлов, что полезно для мапперов.

Для скачивания сейвов есть две команды:
- **/сейв** - использует авторизацию по папке и даёт скачать только из личной папки по относительному пути.
- **/сейв-плюс** - даёт возможность скачать любой сейв по абсолютному пути.


**Авторизация по папке**

Чтобы пользователь мог скачивать сейвы ему нужно привязать свою папку с помощью **/привязать-папку**, команда имеет защиту от привязывания чужих папок, если будет такая попытка, то бот создать оповещение в ветке с оповещениями, если она настроена.


### Статистика пользователя
Любой пользователь имеет свою личную статистику, а именно:
- **в бригадах** - все таски, в которых состоит пользователь
- **выполненные заказы** - все таски, в выполнении которых пользователь участвовал.
- **курирование заказов** - все таски, куратором которых был пользователь.
- **личная папка** - личная папка с сейвами, из которой пользователь может скачивать сейвы.
- **очки** - количество очков, которое на данный момент есть у пользователя.
- **очки за всё время** - сколько очков пользователь заработал за всё время
- **сикей** - параметр, который можно задать командой **/ckey**, ни на что не влияет
- **последняя активность** - когда пользователь последний раз участвовал в выполнении заказов.
- **заметки** - заметки выданные пользователю через **/заметка**.
- **предупреждения** - все предупреждения выданные пользователю через **/предупреждение**.


Такие параметры как **в бригадах**, **выполненные заказы**, **курирование заказов** и **последняя активность** хранят информацию по каждому проекту, в котором участвует пользователь.

Статистика содержит некоторые параметры, которые являются скрытыми и они не видны при просмотре статистики через **/моя-статистика**, а именно: **последняя активность**, **заметки**, **предупреждения**, данные параметры видны только при просмотре через **/статистика**.



# Конфигурация бота
Для запуска этого бота нужно:
- создать приложение в [Discord development portal](https://discord.com/developers/applications)
- добавить его на сервер с флагами `bot` и `applications.command` в OAuth2 URL Generator, а также с правами `Administrator` в `Bot Permissions`.
- клонировать репозиторий `git clone https://github.com/poeMota/Task-bot-discord/`
- создать папку `data` в склонированной папке и поместить в неё весь конфиг бота
- установить все зависимости бота `pip install -r requirements.txt`
- запустить `main.py`


## Создание конфига
В этом разделе подробно разберём как должна выглядеть папка **data** и как настраивать конфиг бота.

### Секретная конфигурация
Часть конфига бота, которую опасно выкладывать в общий доступ хранится в `data/.env`.
шаблон .env файла для бота выглядит так:
```
TOKEN    =
URL      =
NEEDAUTH = true
LOGIN    =
PASSWORD =
```
Разберём каждый пункт:
- **TOKEN** - токен бота для его запуска.
- **URL** - ссылка на nginx сайт для скачивания сейвов.
- **NEEDAUTH** - нужна ли авторизация для входа на этот сайт.
- **LOGIN** - логин для входа на сайт (если нужна авторизация).
- **PASSWORD** - пароль для входа на сайт (если нужна авторизация).


### Основная конфигурация
Остальная конфигурация бота хранится в `data/config.toml`.
Вот как она выглядит:
```toml
guild                 	= 0 # ID сервера
userid_api_url        	= "https://auth.spacestation14.com/api/query/name?" # ссылка на сайт с api для получения ID пользователя SS14, используется для команду /userid
max_dropdowns_per_message = 4 # Максимальное количество выпадающих меню, которые могут быть в одном сообщении, используется в команде /закрыть
log                   	= 0 # ID канала для логов
guest_role            	= 0 # ID роли, которая будет выдаваться при заходе на сервер
notify_log_thread     	= 0 # ID ветки для оповещений

[Localization]
locale_path           	= "locale" # путь до папки с локализацией команд
culture               	= "RU_ru" # название папки с локализацией на определённый язык

[TaskEndRating]
# Раздел с вариантами оценки работы в /закрыть
# название локализации	= коэффициент, на который умножаются базовые очки таска
task-rating-very-good 	= 2
task-rating-good      	= 1.5
task-rating-normal    	= 1
task-rating-bad       	= 0.5
task-rating-no-time   	= 0
task-rating-didnt-working = -0.5

[Task]
brigadire_score_modifier  = 2.0 # коэффициент, на который умножаются базовые очки таска для бригадира
```


### Локализация
Для названий команд, их описания, названия переменных и всего остального в боте используется локализация, которая храниться в по пути `data/locale/`.
Вся локализация хранится в формате **YAML**, локализация поддерживает вставку переменных из кода для этого используется конструкция `{названиеПременной}`, при обработке она будет заменена на значение переменной.

**Формат названия переменных локализации:**
- название команды - `название-команды-command-name`
- описание команды - `название-команды-command-description`
- примечание о команде (используется только командой документации) - `название-команды-command-remark`

- название параметра - `название-команды-command-param-параметр-name`
- описание параметра - `название-команды-command-param-параметр-description`
- примечание о параметре (используется только командой документации) - `название-команды-command-param-параметр-remark`

Остальные вещи, для которых используется локализация не имеют строгого формата.


### Конфиг магазина
Страницы для магазина хранятся в качестве прототипов в `data/magazine.yml`. Ниже приведён пример прототипа страницы магазина и пояснениями:
```yaml
- type: page # только прототипы с таким типом используются в магазине
  name: Повышение # название страницы
  description: Устали быть стажером?  Всего за 18 очков вы можете получить своё долгожданное повышение! # описание страницы, допускается многострочная запись
  price: 18 # цена покупки в очках
  access: [+] # массив ролей, имея хотя бы одну из которым пользователь сможет видеть данную страницу. Данное поле не обязательное, если не указать, то все будут иметь доступ к странице. Регистр названия роли не важен
  notAccess: [маппер] # массив ролей, имея хотя бы одну из которым пользователь не сможет увидеть страницу, имеет больший приоритет чем поле access. Данное поле необязательное. Регистр названия роли не важен
  onBuy: # что происходит при покупке данного лота
  - giveRoles: # выдача ролей при покупке
  	roles: [маппер] # массив ролей, каждая из который будет выдана при покупке
  - removeRoles: # удаление ролей у пользователя при покупке лота
  	roles: [стажер-маппер, +] # массив ролей, каждая из которых будет удалена у пользователя
  - sendMessage: # отправка сообщения в какой либо канал
  	message: "<HeadMapperPing>, нужно выдать Маппера на песке для <AuthorPing>." # сообщение, которое будет отправлено
  	channel: <!NotifiThread> # специальный тег, который обозначает канал, в который будет отправлено сообщение. Также в данном параметре можно числом указать айди канала, куда надо отправить сообщение. Данный параметр необязательный, если не указать, то сообщение будет отправлено в канал, где был открыт магазин
```


Все поля прототипа страницы, которые содержат текст могут использовать локализацию.
Также они могут содержать специальные теги, которые при чтении будут заменены на другие значения.

**Теги бывают двух шаблонов:**
- `<...>`   - тег, который просто заменится на какой-либо текст
- `<!...>` - тег, при наличии которого весь текст будет заменён на какой-либо особый объект

**Список базовых тегов:**
- `<AuthorPing>`  	- заменяется на пинг того, кто открыл магазин
- `<!NotifiThread>`   - заменяет на ветку с оповещениями
- `<!LogChannel>` 	- заменяет на канал с логами

**Пользовательские теги**
Вы можете создавать свои собственные теги, прописав их в `data/magazine_replacements.yml`
Пример:
```yaml
HeadMapperPing: "<@&1181535312304951296>"
```
В данном примере создаётся тег **<HeadMapperPing>**, который заменяется на пинг дискор роли.

При покупке на странице магазина выполняются действия указанные в onBuy, список всех этих действий и их параметров:
- `giveRoles` - выдаёт роли
 - `roles` - массив ролей, которые будут выданы

- `removeRoles` - забирает роли
 - `roles` - массив ролей, которые будут удалены у пользователя

- `sendMessage` - отправляет сообщение от лица бота
 - `message` - сообщение, которое будет отправлено
 - `channel` - канал, куда будет отправлено сообщение, по умолчанию это канал, где был открыт магазин, значение может быть либо специальный тег либо ID канала

### Базы данных
Все данные о проекте, таска, пользователях и посте ролей хранятся в базах данных, в **JSON** файлах в data. **Никогда не рекомендуется изменять их вручную**, как минимум потому что они не очень читаемые для человека и обновляются в реальном времени.

Используемые баз данных:
- `projects.json` - хранит всю информацию о проектах и их тасках
- `members_database.json` - хранит всю статистику пользователей
- `subscribe_post.json` - хранит конфиг постов для выдачи ролей


### Документация по командам
Узнать подробную документацию по использованию команд вы можете с помощью команды **/документация**.


# Готовый конфиг
Вам не приётся вручную создавать папку data и локализацию в ней с нуля, готовую папку data с локализацией для русского языка и примерами конфига можно скачать на данной странице в разделе **Releases**.
